# 營收與機台分類系統開發說明

本文件旨在為開發人員提供關於系統後台「營收報表」的計算邏輯以及「遊戲機台分類系統」的詳細說明，確保對相關數據計算與系統設計有清晰且一致的理解。

## 1. 營收報表計算邏輯

報表的核心是計算在特定時間範圍內，每台機器的「總收入」與「總支出」，進而得出「淨利」。所有計算都基於 `machine_data` 資料表中的點數變化量，並乘以 `machines` 資料表中為每台機器獨立設定的金額換算比例。

### 1.1 資料庫欄位對應關係

計算邏輯的正確性高度依賴於以下兩個資料表的欄位：

#### `machine_data` (原始數據記錄表)
- `credit_in`: 投幣或使用紙鈔機所增加的點數。
- `assign_credit`: 由服務員手動開分所增加的點數。
- `coin_out`: **主退法**所扣除的點數 (例如：退幣、輸出彩票、輸出點數卡)。
- `settled_credit`: **洗分**所扣除的點數。

#### `machines` (機台設定表)
- `coin_input_value`: **投幣/紙鈔價值**。每 1 點 `credit_in` 對應的金額。
- `credit_button_value`: **開分按鈕價值**。每 1 點 `assign_credit` 對應的金額。
- `payout_unit_value`: **主退法單位價值**。每 1 點 `coin_out` 對應的支出金額。
- `payout_button_value`: **洗分按鈕價值**。每 1 點 `settled_credit` 對應的支出金額。

### 1.2 計算公式

#### 1.2.1 點數變化量 (Delta)
計算的第一步是獲取指定時間範圍內，各項點數的期末值與期初值，來計算出變化量 (Delta)。

- `delta_credit_in` = (期末 `credit_in`) - (期初 `credit_in`)
- `delta_assign_credit` = (期末 `assign_credit`) - (期初 `assign_credit`)
- `delta_coin_out` = (期末 `coin_out`) - (期初 `coin_out`)
- `delta_settled_credit` = (期末 `settled_credit`) - (期初 `settled_credit`)

> **注意**：若計算出的 Delta 值為負數，表示機台的計數器可能發生了重置。在這種情況下，應直接取「期末值」作為該期間的變化量。

#### 1.2.2 營收計算
- **投幣/紙鈔收入** = `delta_credit_in` * `machines.coin_input_value`
- **服務員開分收入** = `delta_assign_credit` * `machines.credit_button_value`
- **總收入** = (投幣/紙鈔收入) + (服務員開分收入)

#### 1.2.3 支出計算
- **主退法支出** = `delta_coin_out` * `machines.payout_unit_value`
- **洗分支出** = `delta_settled_credit` * `machines.payout_button_value`
- **總支出** = (主退法支出) + (洗分支出)

#### 1.2.4 淨利計算
- **淨利** = (總收入) - (總支出)

### 1.3 範例說明

假設一台「賭博機A」在 `machines` 表中的設定如下：
- `coin_input_value` = 1.00 (投1元得1點)
- `credit_button_value` = 100.00 (開分1次加100點)
- `payout_unit_value` = 1.00 (主退法1點退1元)
- `payout_button_value` = 100.00 (洗分1次扣100點)

某日 `machine_data` 的點數變化如下：
- `delta_credit_in` = 500
- `delta_assign_credit` = 2
- `delta_coin_out` = 150
- `delta_settled_credit` = 3

計算過程：
- **總收入** = (500 * 1.00) + (2 * 100.00) = 500 + 200 = 700 元
- **總支出** = (150 * 1.00) + (3 * 100.00) = 150 + 300 = 450 元
- **淨利** = 700 - 450 = 250 元

## 2. 遊戲機台分類系統設計 (V2)

### 2.1 背景與目標

**V1 的挑戰**：舊有的機台分類系統僅依賴一個單一的 `machine_type` 欄位。這個欄位混合了機台的「營運模式」（如：彩票機、賭博機）和「外觀描述」（如：大型音樂遊戲機、拳擊機），形成了一個又長又混亂的列表。這導致了以下問題：
- **分類不清晰**：使用者難以快速理解和選擇正確的機台類型。
- **擴展性差**：新增機台類型時，列表會無限增長，難以維護。
- **統計困難**：無法對具有相同「營運模式」但「外觀不同」的機台進行有效的數據統計與分析。

**V2 的目標**：新的分類系統旨在將機台的 **核心營運模式** 與 **外觀描述** 徹底分離。透過一個引導式的流程，讓使用者能夠準確地定義一台機台的本質，從而使系統的管理、擴展和數據分析都變得更加高效和直觀。

### 2.2 核心設計：三步引導式分類

在「新增/編輯機台」的彈出視窗中，採用了全新的三步式分類法，引導使用者完成設定。

#### 步驟一：選擇「主要營運模式」(machine_category)
這是最關鍵的一步，它定義了機台的根本商業邏輯和行為模式。使用者需要從以下幾個預設的模板中選擇：
- **純娛樂型** (`template_entertainment_only`): 玩家投幣後純粹進行遊戲，遊戲結束後沒有任何形式的獎勵返還。
- **獎勵型** (`template_redemption`): 玩家投幣玩遊戲，並根據遊戲表現獲得獎勵（如彩票、點數、獎品）。這是最常見的獎勵型機台。
- **彈珠台/柏青哥** (`template_pinball`): 特指彈珠台或柏青哥類機台，其核心玩法是「用珠子玩遊戲，再贏得珠子」。
- **賭博機** (`template_gambling`): 主要透過「開分」和「洗分」進行記帳的電子遊戲機，通常有明確的返還率（RTP）設定。
- **功能型機台** (`template_utility`): 功能型機台，其主要目的不是提供遊戲娛樂，而是進行價值交換，如紙鈔兌換代幣機或儲值機。

#### 步驟二：定義「詳細功能」
根據第一步選擇的「主要營運模式」，系統會動態地展示後續的設定選項。
- **獎品類型** (`payout_type`): 如果機台是獎勵型或彈珠台，系統會要求使用者進一步定義其主要的產出物是什麼。例如：
    - 柏青哥 (`payout_type_pachinko`)
    - 彩票 (`payout_type_tickets`)
    - 點數 (`payout_type_points`)
    - 夾娃娃機 (`payout_type_prize_claw`)
    - 代幣 (`payout_type_coins`)
- **可選模組** (`optional_modules`): 某些營運模式下，可以掛載額外的功能模組。例如，為一台「獎勵型遊戲機」增加「紙鈔機」功能。

#### 步驟三：填寫「機台外觀型號」 (machine_type)
這一步沿用了舊的 `machine_type` 欄位，但其意義已轉變為一個選填的、純描述性的欄位。使用者可以在這裡填寫機台的具體外觀或市場上的通用名稱，例如「空中籃球」或「太鼓達人」。這個欄位主要用於方便日常辨識和篩選，不直接參與核心的統計與分類邏輯。

### 2.3 對系統的影響

這個全新的分類系統對整個專案產生了全面而正向的影響：
- **資料庫層**：`machines` 資料表中新增了 `machine_category` 欄位，作為主要的分類依據。
- **前端介面層**：新增/編輯機台的表單變得更加使用者友善和具有邏輯性，避免了混淆。
- **後端控制層**：控制器現在處理的是結構化、有邏輯的數據，驗證和儲存邏輯更為清晰。
- **報表與分析**：現在可以輕易地對所有 `machine_category` 為「獎勵型遊戲機」的機台進行匯總分析，無論它們的外觀是什麼，這為數據驅動決策提供了極大便利。

---
*文件版本: 1.0*
*最後更新日期: 2025-07-20*

## 修改記錄
- **2025-07-20**: 更新文件，新增「修改記錄」區塊。
