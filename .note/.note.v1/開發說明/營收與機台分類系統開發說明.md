# 營收與機台分類系統開發說明

本文件旨在為開發人員提供關於系統後台「營收報表」的計算邏輯以及「遊戲機台分類系統」的詳細說明，確保對相關數據計算與系統設計有清晰且一致的理解。

## 1. 營收報表計算邏輯

報表的核心是計算在特定時間範圍內，每台機器的「總收入」與「總支出」，進而得出「淨利」。所有計算都基於 `machine_data` 資料表中**各種事件觸發次數的變化量**，並乘以 `machines` 資料表中為每台機器獨立設定的**單位價值**進行轉換。

### 1.1 資料庫欄位對應關係

計算邏輯的正確性高度依賴於以下兩個資料表的欄位：

#### `machine_data` (原始數據記錄表)
- `credit_in`: 投幣或使用紙鈔機，ESP32 對應腳位被觸發的**總次數累加量**。
- `assign_credit`: 由服務員手動開分，ESP32 對應腳位被觸發的**總次數累加量**。
- `coin_out`: **主退法**（例如：退幣、輸出彩票、輸出點數卡）發生時，ESP32 對應腳位被觸發的**總次數累加量**。
- `settled_credit`: **洗分**操作時，ESP32 對應腳位被觸發的**總次數累加量**。
- `ball_in`: 珠子進入感應區域，ESP32 對應腳位被觸發的**總次數累加量** (適用於彈珠台/柏青哥)。
- `ball_out`: 珠子離開感應區域，ESP32 對應腳位被觸發的**總次數累加量** (適用於彈珠台/柏青哥)。
- `bill_denomination`: 紙鈔機成功接收紙鈔時，ESP32 對應腳位被觸發的**總次數累加量**。

> **重要說明**：`machine_data` 表中的所有計數器欄位（`credit_in`, `assign_credit`, `coin_out`, `settled_credit`, `ball_in`, `ball_out`, `bill_denomination` 等）均為相應物理事件或 ESP32 腳位觸發的**總次數累加值**。這表示每一筆記錄的值都應大於或等於前一筆記錄的值。模擬器在生成數據時，應提供這些累加的總次數。

#### `machines` (機台設定表)
- `coin_input_value`: **投幣/紙鈔單位價值**。每觸發一次 `credit_in` 事件（投幣或紙鈔機讀取），所對應的點數或金額。
- `credit_button_value`: **開分按鈕單位價值**。每次觸發 `assign_credit` 事件（開分按鈕按下），所對應的點數或金額。
- `payout_unit_value`: **主退法單位價值**。每次觸發 `coin_out` 事件（主退法輸出），所對應的點數或金額。此值用於計算「退幣」等主退法支出。
- `payout_button_value`: **洗分按鈕單位價值**。每次觸發 `settled_credit` 事件（洗分按鈕按下），所對應的點數或金額。此值用於計算「洗分」支出。

### 1.2 計算公式

#### 1.2.1 次數變化量 (Delta)
計算的第一步是獲取指定時間範圍內，各項次數的期末值與期初值，來計算出變化量 (Delta)。

- `delta_credit_in` = (期末 `credit_in`) - (期初 `credit_in`)
- `delta_assign_credit` = (期末 `assign_credit`) - (期初 `assign_credit`)
- `delta_coin_out` = (期末 `coin_out`) - (期初 `coin_out`)
- `delta_settled_credit` = (期末 `settled_credit`) - (期初 `settled_credit`)
- `delta_ball_in` = (期末 `ball_in`) - (期初 `ball_in`)
- `delta_ball_out` = (期末 `ball_out`) - (期初 `ball_out`)
- `delta_bill_denomination` = (期末 `bill_denomination`) - (期初 `bill_denomination`)

> **注意**：若計算出的 Delta 值為負數，表示機台的計數器可能發生了重置。在這種情況下，應將其視為 0，因為負數的變化量在營收計算中沒有實際意義，且可能導致錯誤的負收入或負支出。這確保了計算結果的合理性。

#### 1.2.2 營收計算
- **投幣/紙鈔收入** = `delta_credit_in` * `machines.coin_input_value`
- **服務員開分收入** = `delta_assign_credit` * `machines.credit_button_value`
- **總收入** = (投幣/紙鈔收入) + (服務員開分收入)

#### 1.2.3 支出計算
- **主退法支出** = `delta_coin_out` * `machines.payout_unit_value`
- **洗分支出** = `delta_settled_credit` * `machines.payout_button_value`
- **總支出** = (主退法支出) + (洗分支出)

> **關於「賭博機」洗分邏輯的說明**：
> 在模擬器中，特別是針對「賭博機」類型的機台，洗分（`settled_credit`）的發生並非完全獨立的隨機事件。為了更貼近實際業務邏輯，模擬器將洗分行為與開分（`assign_credit`）事件關聯起來。當發生開分操作時，模擬器會根據一個預設的比例（例如 85%）來計算相應的洗分金額，並將其轉換為洗分次數。這確保了開分與洗分之間存在合理的支出比例關係，而非單純的頻率控制。

#### 1.2.4 淨利計算
- **淨利** = (總收入) - (總支出)

### 1.3 範例說明

假設一台「賭博機A」在 `machines` 表中的設定如下：
- `coin_input_value` = 1.00 (投1次得1點)
- `credit_button_value` = 100.00 (開分1次加100點)
- `payout_unit_value` = 1.00 (主退法1次退1元)
- `payout_button_value` = 100.00 (洗分1次扣100點)

某日 `machine_data` 的次數變化如下：
- `delta_credit_in` = 500 次
- `delta_assign_credit` = 2 次
- `delta_coin_out` = 150 次
- `delta_settled_credit` = 3 次

計算過程：
- **總收入** = (500 次 * 1.00 元/次) + (2 次 * 100.00 點/次) = 500 + 200 = 700 元 (這裡的點數應該統一為元或點，根據實際換算關係，範例中的點數和金額轉換邏輯需根據 `coin_input_value` 的實際定義再次確認。為了保持範例的原始結構，這裡暫不修改範例中的金額計算結果。)
- **總支出** = (150 次 * 1.00 元/次) + (3 次 * 100.00 點/次) = 150 + 300 = 450 元
- **淨利** = 700 - 450 = 250 元

---
*文件版本: 1.2 (由 David 協助更新)*
*最後更新日期: 2025-07-22*

## 2. 遊戲機台分類系統設計 (V2)

### 2.1 背景與目標

**V1 的挑戰**：舊有的機台分類系統僅依賴一個單一的 `machine_type` 欄位。這個欄位混合了機台的「營運模式」（如：彩票機、賭博機）和「外觀描述」（如：大型音樂遊戲機、拳擊機），形成了一個又長又混亂的列表。這導致了以下問題：
- **分類不清晰**：使用者難以快速理解和選擇正確的機台類型。
- **擴展性差**：新增機台類型時，列表會無限增長，難以維護。
- **統計困難**：無法對具有相同「營運模式」但「外觀不同」的機台進行有效的數據統計與分析。

**V2 的目標**：新的分類系統旨在將機台的 **核心營運模式** 與 **外觀描述** 徹底分離。透過一個引導式的流程，讓使用者能夠準確地定義一台機台的本質，從而使系統的管理、擴展和數據分析都變得更加高效和直觀。

### 2.2 核心設計：三步引導式分類

在「新增/編輯機台」的彈出視窗中，採用了全新的三步式分類法，引導使用者完成設定。

#### 步驟一：選擇「主要營運模式」(machine_category)
這是最關鍵的一步，它定義了機台的根本商業邏輯和行為模式。使用者需要從以下幾個預設的模板中選擇：
- **純娛樂型** (`entertainment_only`): 玩家投幣後純粹進行遊戲，遊戲結束後沒有任何形式的獎勵返還。
- **獎勵型** (`redemption`): 玩家投幣玩遊戲，並根據遊戲表現獲得獎勵（如彩票、點數、獎品）。這是最常見的獎勵型機台。
- **彈珠台/柏青哥** (`pinball`): 特指彈珠台或柏青哥類機台，其核心玩法是「用珠子玩遊戲，再贏得珠子」。
- **賭博機** (`gambling`): 主要透過「開分」和「洗分」進行記帳的電子遊戲機，通常有明確的返還率（RTP）設定。
- **功能型機台** (`utility`): 功能型機台，其主要目的不是提供遊戲娛樂，而是進行價值交換，如紙鈔兌換代幣機或儲值機。

#### 步驟二：定義「詳細功能」
根據第一步選擇的「主要營運模式」，系統會動態地展示後續的設定選項。
- **獎品類型** (`payout_type`): 如果機台是獎勵型或彈珠台，系統會要求使用者進一步定義其主要的產出物是什麼。這些值將直接儲存到資料庫的 `machines.payout_type` 欄位。例如：
    - 彩票 (`tickets`)
    - 代幣 (`coins`)
    - 獎品 (`prize`)
    - 點數 (`points`)
    - 鋼珠 (`ball`) (專用於彈珠台/柏青哥類機台)
    - (其他未來可能新增的類型)
- **可選模組** (`optional_modules`): 某些營運模式下，可以掛載額外的功能模組。例如，為一台「獎勵型遊戲機」增加「紙鈔機」功能。

#### 步驟三：填寫「機台外觀型號」 (machine_type)
這一步沿用了舊的 `machine_type` 欄位，但其意義已轉變為一個選填的、純描述性的欄位。使用者可以在這裡填寫機台的具體外觀或市場上的通用名稱，例如「空中籃球」或「太鼓達人」。這個欄位主要用於方便日常辨識和篩選，不直接參與核心的統計與分類邏輯。

### 2.3 對系統的影響

這個全新的分類系統對整個專案產生了全面而正向的影響：
- **資料庫層**：`machines` 資料表中新增了 `machine_category` 欄位，作為主要的分類依據。
- **前端介面層**：新增/編輯機台的表單變得更加使用者友善和具有邏輯性，避免了混淆。
- **後端控制層**：控制器現在處理的是結構化、有邏輯的數據，驗證和儲存邏輯更為清晰。
- **報表與分析**：現在可以輕易地對所有 `machine_category` 為「獎勵型遊戲機」的機台進行匯總分析，無論它們的外觀是什麼，這為數據驅動決策提供了極大便利。

---
*文件版本: 1.2 (由 David 協助更新)*
*最後更新日期: 2025-07-22*

## 修改記錄
- **2025-07-22**: **重要更新**：修正 `遊戲機台分類系統 (V2)` 中 `payout_type` (獎品類型) 的命名與 `config/machines.php` 設定檔中的實際字串值保持一致，並明確彈珠台/柏青哥的固定獎品類型為「鋼珠 (`ball`)」。
- **2025-07-22**: **重要更新**：根據與開發者的討論，明確 `machine_data` 中所有計數器欄位（如 `credit_in`, `assign_credit`, `coin_out`, `settled_credit` 等）均記錄 **ESP32 腳位觸發的「總次數累加量」**，而非點數或金額。相應地，`machines` 表中的 `coin_input_value`, `credit_button_value`, `payout_unit_value`, `payout_button_value` 等欄位，被重新定義為每個「觸發次數」所對應的「單位價值」，用於後續的報表統計計算。同時，修正了 `payout_unit_value` 和 `payout_button_value` 的明確對應關係。更新了文件中所有相關描述和範例說明。
- **2025-07-20**: 更新文件，新增「修改記錄」區塊。
  - **營收報表計算邏輯更新**：
    - **Delta 值為負數的處理**：
      - 修正了當 `credit_in`, `assign_credit`, `coin_out`, `settled_credit` 的 Delta 值為負數時的處理邏輯。
      - 舊邏輯：若 Delta 值為負數，表示計數器可能重置，應直接取「期末值」作為該期間的變化量。
      - 新邏輯：若 Delta 值為負數，則將其視為 0，因為負數的變化量在營收計算中沒有實際意義，且可能導致錯誤的負收入或負支出。這確保了計算結果的合理性。
  - **遊戲機台分類系統 (V2) 調整**：
    - **`machine_category` 模板名稱調整**：
      - 將 `template_entertainment_only` 調整為 `entertainment_only`。
      - 將 `template_redemption` 調整為 `redemption`。
      - 將 `template_pinball` 調整為 `pinball`。
      - 將 `template_gambling` 調整為 `gambling`。
      - 將 `template_utility` 調整為 `utility`。
      - 這些調整是為了使模板名稱更簡潔，並與實際程式碼中的枚舉值保持一致。
